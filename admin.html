<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Admin | JB Jidousha Cursos</title>
    
    <style>
        /* [O CSS do Admin est치 aqui...] */
        :root {
            --accent-color: #DAA52D; 
            --action-color: #1463a5; 
            --error-color: #dc3545;
            --bg-color: #f0f0f0;
            --content-bg: #FFFFFF;
        }
        body { font-family: Arial, sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; }
        .container {
            max-width: 800px; 
            background-color: var(--content-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 2rem; 
            margin: 0 auto; 
        }
        h1 { text-align: center; color: var(--action-color); margin-top: 0; }
        h3 { color: var(--action-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 5px; margin-top: 30px; }
        label { font-weight: bold; margin-bottom: 5px; display: block; }
        
        input[type="text"], input[type="password"], input[type="email"], textarea, select, input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box; 
        }
        
        button { 
            padding: 12px; 
            border: none; 
            border-radius: 4px; 
            font-size: 1rem; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%;
            background-color: var(--action-color);
            color: white;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #0d4a7c; }
        #btnLogout { background-color: #777; margin-top: 20px; }
        
        #status, #loginStatus { 
            text-align: center; 
            font-weight: bold; 
            margin-top: 15px; 
            padding: 10px; 
            border-radius: 4px; 
        }
        .status.success { color: #28a745; background-color: #e9f7ec; }
        .status.error { color: #dc3545; background-color: #fdeeee; }
        .status.loading { color: #007bff; background-color: #e6f2ff; }
        
        #login-section, #admin-section {
            border-top: 5px solid var(--accent-color);
            padding-top: 20px;
        }
        
        /* Estilos da lista de gest칚o */
        .management-list { list-style-type: none; padding-left: 0; }
        .course-item, .module-item, .lesson-item {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .course-item > div, .module-item > div, .lesson-item > div {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .module-list { padding-left: 20px; }
        .lesson-list { padding-left: 40px; }
        
        .delete-btn {
            background-color: var(--error-color);
            color: white;
            padding: 4px 8px;
            font-size: 0.8em;
            width: auto; /* Tamanho autom치tico */
            font-weight: normal;
        }
        
        /* NOVO: Estilo do Formul치rio 5 */
        #student-lookup-result {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 15px;
            margin-top: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Admin JB Jidousha Cursos</h1>

        <section id="login-section">
            <h3>Acesso Restrito</h3>
            <form id="loginForm">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" required>
                <label for="login-password">Senha:</label>
                <input type="password" id="login-password" required>
                <button type="submit" id="btnLogin">Entrar</button>
            </form>
            <div id="loginStatus" class="status"></div>
        </section>

        <section id="admin-section" style="display: none;">
            
            <div id="status" class="status"></div>

            <h3>1. Adicionar Novo Curso</h3>
            <form id="formCurso">
                <label for="course-id">ID 칔nico do Curso (sem espa칞os):</label>
                <input type="text" id="course-id" placeholder="Ex: curso_higienizacao_v1" required>
                
                <label for="course-title">T칤tulo do Curso:</label>
                <input type="text" id="course-title" placeholder="Ex: Higieniza칞칚o Profissional" required>
                
                <label for="course-subtitle">Subt칤tulo (Descri칞칚o Curta):</label>
                <input type="text" id="course-subtitle" placeholder="O ponto de partida para a sua nova profiss칚o." required>
                
                <label for="course-icon">칈cone (FontAwesome):</label>
                <input type="text" id="course-icon" placeholder="Ex: fa-car-wash" required>

                <button type="submit">Salvar Novo Curso</button>
            </form>
            
            <hr style="margin: 30px 0;">

            <h3>2. Adicionar Novo M칩dulo</h3>
            <form id="formModulo">
                <label for="module-course">Selecionar Curso:</label>
                <select id="module-course" required>
                    <option value="">-- Carregando Cursos... --</option>
                </select>
                
                <label for="module-title">T칤tulo do M칩dulo:</label>
                <input type="text" id="module-title" placeholder="Ex: M칩dulo 1: Fundamentos" required>
                
                <label for="module-order">Ordem (N칰mero):</label>
                <input type="number" id="module-order" placeholder="1" required>
                
                <button type="submit">Salvar M칩dulo</button>
            </form>
            
            <hr style="margin: 30px 0;">
            
            <form id="formAula">
                <h3>3. Adicionar Nova Aula</h3>
                
                <label for="lesson-course-select">Selecionar Curso (para filtrar m칩dulos):</label>
                <select id="lesson-course-select" required>
                    <option value="">-- Carregando Cursos... --</option>
                </select>

                <label for="lesson-module">Selecionar M칩dulo:</label>
                <select id="lesson-module" required>
                    <option value="">-- Selecione um curso primeiro --</option>
                </select>
                
                <label for="lesson-title">T칤tulo da Aula:</label>
                <input type="text" id="lesson-title" placeholder="Ex: 1.1 Seguran칞a e Produtos" required>
                
                <label for="lesson-videoid">ID do V칤deo (YouTube):</label>
                <input type="text" id="lesson-videoid" placeholder="Ex: iWiE3_bToUk" required>
                
                <label for="lesson-description">Descri칞칚o Curta:</label>
                <textarea id="lesson-description" rows="3" placeholder="O que o aluno vai aprender..."></textarea>
                
                <label for="lesson-order">Ordem (N칰mero):</label>
                <input type="number" id="lesson-order" placeholder="1" required>

                <button type="submit" id="btnSalvarAula">Salvar Aula</button>
            </form>
            
            <hr style="margin: 30px 0;">
            
            <h3>4. Gerir Cursos Padr칚o (para Novos Alunos)</h3>
            <form id="formDefaultCourses">
                <label for="default-courses">IDs dos Cursos Padr칚o (separados por v칤rgula):</label>
                <input type="text" id="default-courses" placeholder="Ex: curso_higienizacao,curso_polimento">
                <p style="font-size: 0.8em; color: #666; margin-top: -10px;">O(s) curso(s) que novos alunos recebem ao se registar.</p>
                <button type="submit">Salvar Cursos Padr칚o</button>
            </form>

            <hr style="margin: 30px 0;">

            <h3>5. Gerir Alunos (Liberar Cursos)</h3>
            <form id="formManageStudent">
                <label for="student-email">Procurar Aluno por E-mail:</label>
                <input type="email" id="student-email" placeholder="aluno@exemplo.com" required>
                <button type_ ="button" id="btnSearchStudent">Procurar Aluno</button>
            </form>
            
            <div id="student-lookup-result" style="display:none;">
                <h4 id="student-name">Nome do Aluno</h4>
                <p>Cursos Atuais: <span id="student-courses"></span></p>
                
                <hr>
                <label for="course-to-add">Adicionar novo curso a este aluno:</label>
                <select id="course-to-add">
                    <option value="">-- Selecione o curso para liberar --</option>
                </select>
                <button type="button" id="btnAddCourseToStudent" style="background-color: var(--accent-color); color: #333; margin-top: 10px;">Liberar Curso para Aluno</button>
            </div>
            
            <hr style="margin: 30px 0;">
            
            <h3>Conte칰do Atual da Plataforma</h3>
            <div id="content-list">
                </div>

            <button id="btnLogout">Sair (Logout)</button>
        </section>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 

    <script>
      // 游댐 SUAS CHAVES REAIS
      const firebaseConfig = {
        apiKey: "AIzaSyB3LB3er6lGKd95kHmOlFvO_WappclfOEg",
        authDomain: "jb-jidousha-curso.firebaseapp.com",
        projectId: "jb-jidousha-curso",
        storageBucket: "jb-jidousha-curso.firebasestorage.app",
        messagingSenderId: "825134171693",
        appId: "1:825134171693:web:d4284a093ed261c97a1aa4",
        measurementId: "G-QLS2RVCTQ6"
      };

      // Inicializa칞칚o
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth(); 

      // Cole칞칫es
      const CURSOS_COLLECTION = "cursos";
      const MODULOS_COLLECTION = "modulos";
      const AULAS_COLLECTION = "aulas";
      const USERS_COLLECTION = "users";
      const CONFIG_COLLECTION = "configuracoes"; // NOVO

      // Elementos do HTML
      const loginSection = document.getElementById('login-section');
      const adminSection = document.getElementById('admin-section');
      const loginForm = document.getElementById('loginForm');
      const loginStatusDiv = document.getElementById('loginStatus');
      const statusDiv = document.getElementById('status');
      const btnLogout = document.getElementById('btnLogout');
      
      const formCurso = document.getElementById('formCurso');
      const formModulo = document.getElementById('formModulo');
      const formAula = document.getElementById('formAula');
      const formDefaultCourses = document.getElementById('formDefaultCourses'); 
      
      const selectCourseInModuloForm = document.getElementById('module-course'); // Form 2
      const selectCourseInAulaForm = document.getElementById('lesson-course-select'); // Form 3
      const selectModuleInAulaForm = document.getElementById('lesson-module'); // Form 3
      
      const contentListDiv = document.getElementById('content-list');
      const defaultCoursesInput = document.getElementById('default-courses'); 

      // NOVO: Formul치rio 5
      const btnSearchStudent = document.getElementById('btnSearchStudent');
      const studentLookupResult = document.getElementById('student-lookup-result');
      const selectCourseToAdd = document.getElementById('course-to-add');
      const btnAddCourseToStudent = document.getElementById('btnAddCourseToStudent');
      let foundStudentId = null; // Guarda o ID do aluno encontrado

      let cacheCursos = []; 
      let cacheModulos = []; 

      function showStatus(div, message, type) {
          div.textContent = message;
          div.className = 'status ' + type; 
      }

      // --- L칍GICA DE CARREGAMENTO ---

      async function loadAllContent() {
          // Limpa menus e lista
          selectCourseInModuloForm.innerHTML = '<option value="">-- Selecione o Curso --</option>';
          selectCourseInAulaForm.innerHTML = '<option value="">-- Selecione o Curso --</option>';
          selectModuleInAulaForm.innerHTML = '<option value="">-- Selecione um curso primeiro --</option>'; 
          selectCourseToAdd.innerHTML = '<option value="">-- Selecione o curso para liberar --</option>'; // NOVO
          
          contentListDiv.innerHTML = '<p>Carregando...</p>';
          
          cacheCursos = [];
          cacheModulos = [];
          
          try {
              // 1. Buscar Cursos
              const coursesSnapshot = await db.collection(CURSOS_COLLECTION).get();
              coursesSnapshot.forEach(doc => {
                  const course = doc.data();
                  course.id = doc.id;
                  cacheCursos.push(course);
                  selectCourseInModuloForm.innerHTML += `<option value="${course.id}">${course.title}</option>`;
                  selectCourseInAulaForm.innerHTML += `<option value="${course.id}">${course.title}</option>`;
                  selectCourseToAdd.innerHTML += `<option value="${course.id}">${course.title} (ID: ${course.id})</option>`; // NOVO
              });
              
              // 2. Buscar M칩dulos
              const modulesSnapshot = await db.collection(MODULOS_COLLECTION).orderBy("order").get();
              modulesSnapshot.forEach(doc => {
                  const modulo = doc.data();
                  modulo.id = doc.id;
                  cacheModulos.push(modulo);
              });

              // 3. Buscar Aulas
              const lessonsSnapshot = await db.collection(AULAS_COLLECTION).orderBy("order").get();
              const allLessons = {};
              lessonsSnapshot.forEach(doc => {
                  const lesson = doc.data();
                  lesson.id = doc.id;
                  if (!allLessons[lesson.moduleId]) {
                      allLessons[lesson.moduleId] = [];
                  }
                  allLessons[lesson.moduleId].push(lesson);
              });
              
              // 4. Renderizar a Lista Completa
              renderContentList(cacheCursos, cacheModulos, allLessons);
              
              // 5. Buscar os Cursos Padr칚o
              const configDoc = await db.collection(CONFIG_COLLECTION).doc('default_courses').get();
              if (configDoc.exists) {
                  defaultCoursesInput.value = (configDoc.data().coursesOwned || []).join(',');
              }

          } catch (error) {
              console.error("Erro ao carregar conte칰do:", error);
              showStatus(statusDiv, "Erro ao carregar conte칰do: " + error.message, "error");
          }
      }
      
      // Fun칞칚o para renderizar a lista
      function renderContentList(cursos, modulos, aulas) {
          let html = '<ul class="management-list">';
          
          cursos.forEach(curso => {
              html += `<li class="course-item">
                          <div>
                              <strong>${curso.title} (ID: ${curso.id})</strong>
                              <button class="delete-btn" data-id="${curso.id}" data-type="curso">Excluir Curso</button>
                          </div>`;
              
              const modulosDoCurso = modulos.filter(m => m.courseId === curso.id);
              
              if (modulosDoCurso.length > 0) {
                  html += '<ul class="module-list">';
                  modulosDoCurso.forEach(modulo => {
                      html += `<li class="module-item">
                                  <div>
                                      ${modulo.title} (Ordem: ${modulo.order})
                                      <button class="delete-btn" data-id="${modulo.id}" data-type="modulo">Excluir M칩dulo</button>
                                  </div>`;
                      
                      if (aulas[modulo.id] && aulas[modulo.id].length > 0) {
                          html += '<ul class="lesson-list">';
                          aulas[modulo.id].forEach(aula => {
                              html += `<li class="lesson-item">
                                          <div>
                                              ${aula.title} (Ordem: ${aula.order})
                                              <button class="delete-btn" data-id="${aula.id}" data-type="aula">Excluir Aula</button>
                                          </div>
                                      </li>`;
                          });
                          html += '</ul>';
                      }
                      html += '</li>';
                  });
                  html += '</ul>';
              }
              html += '</li>';
          });
          html += '</ul>';
          contentListDiv.innerHTML = html;
      }
      

      // --- L칍GICA DE EVENTOS ---

      // Fun칞칫es de Excluir
      async function deleteItem(id, collectionName) {
          const confirmationText = collectionName === CURSOS_COLLECTION ? 
              'EXCLUIR CURSO? Isto apagar치 o curso, mas N츾O os m칩dulos ou aulas dentro dele (fa칞a isso manualmente).' :
              (collectionName === MODULOS_COLLECTION ? 
              'EXCLUIR M칍DULO? Isto N츾O apagar치 as aulas dentro dele (fa칞a isso manualmente).' :
              'EXCLUIR AULA?');
              
          if (!confirm(confirmationText)) return;
          
          try {
              await db.collection(collectionName).doc(id).delete();
              showStatus(statusDiv, "Item exclu칤do com sucesso!", "success");
              loadAllContent(); // Recarrega tudo
          } catch (error) {
              showStatus(statusDiv, "Erro ao excluir: " + error.message, "error");
          }
      }
      
      // Event listener para os cliques na lista (excluir)
      contentListDiv.addEventListener('click', (e) => {
          if (e.target.classList.contains('delete-btn')) {
              const id = e.target.dataset.id;
              const type = e.target.dataset.type;
              
              if (type === 'curso') deleteItem(id, CURSOS_COLLECTION);
              if (type === 'modulo') deleteItem(id, MODULOS_COLLECTION);
              if (type === 'aula') deleteItem(id, AULAS_COLLECTION);
          }
      });
      
      // Event Listener para filtrar os m칩dulos quando um curso 칠 selecionado (NO FORM 3)
      selectCourseInAulaForm.addEventListener('change', () => {
          const selectedCourseId = selectCourseInAulaForm.value;
          populateModuleSelect(selectedCourseId);
      });
      
      // Fun칞칚o: Popula o dropdown de M칩dulos (Form 3)
      function populateModuleSelect(selectedCourseId) {
          selectModuleInAulaForm.innerHTML = '<option value="">-- Selecione o M칩dulo --</option>'; // Limpa

          if (!selectedCourseId) {
              selectModuleInAulaForm.innerHTML = '<option value="">-- Selecione um curso primeiro --</option>';
              return;
          }

          // Filtra o cache de m칩dulos
          const modulosDoCurso = cacheModulos.filter(m => m.courseId === selectedCourseId);
          
          if (modulosDoCurso.length === 0) {
              selectModuleInAulaForm.innerHTML = '<option value="">-- Nenhum m칩dulo para este curso --</option>';
          }

          // Adiciona os m칩dulos filtrados ao dropdown
          modulosDoCurso.forEach(modulo => {
              selectModuleInAulaForm.innerHTML += `<option value="${modulo.id}">${modulo.title}</option>`;
          });
      }


      // 1. Salvar Curso
      formCurso.addEventListener('submit', async (e) => {
          e.preventDefault();
          const courseId = document.getElementById('course-id').value; // Pega o ID manual
          const title = document.getElementById('course-title').value;
          const subtitle = document.getElementById('course-subtitle').value;
          const icon = document.getElementById('course-icon').value;
          
          if (!courseId) {
              showStatus(statusDiv, "Erro: O ID 칔nico do Curso 칠 obrigat칩rio.", "error");
              return;
          }
          
          try {
              await db.collection(CURSOS_COLLECTION).doc(courseId).set({
                  title: title,
                  subtitle: subtitle,
                  icon: icon
              });
              showStatus(statusDiv, "Curso salvo com sucesso!", "success");
              formCurso.reset();
              loadAllContent(); // Recarrega tudo
          } catch (error) {
              showStatus(statusDiv, "Erro ao salvar curso: " + error.message, "error");
          }
      });
      
      // 2. Salvar M칩dulo
      formModulo.addEventListener('submit', async (e) => {
          e.preventDefault();
          const courseId = document.getElementById('module-course').value;
          const title = document.getElementById('module-title').value;
          const order = parseInt(document.getElementById('module-order').value);
          
          if (!courseId) {
              showStatus(statusDiv, "Erro: Selecione um curso.", "error");
              return;
          }
          
          try {
              await db.collection(MODULOS_COLLECTION).add({
                  courseId: courseId,
                  title: title,
                  order: order
              });
              showStatus(statusDiv, "M칩dulo salvo com sucesso!", "success");
              formModulo.reset();
              loadAllContent(); 
          } catch (error) {
              showStatus(statusDiv, "Erro ao salvar m칩dulo: " + error.message, "error");
          }
      });
      
      // 3. Salvar Aula
      formAula.addEventListener('submit', async (e) => {
          e.preventDefault();
          const moduleId = document.getElementById('lesson-module').value; // Corrigido
          const title = document.getElementById('lesson-title').value;
          const videoId = document.getElementById('lesson-videoid').value;
          const description = document.getElementById('lesson-description').value;
          const order = parseInt(document.getElementById('lesson-order').value);

          if (!moduleId) {
              showStatus(statusDiv, "Erro: Selecione um m칩dulo.", "error");
              return;
          }

          try {
              await db.collection(AULAS_COLLECTION).add({
                  moduleId: moduleId,
                  title: title,
                  videoId: videoId,
                  description: description,
                  order: order
              });
              showStatus(statusDiv, "Aula salva com sucesso!", "success");
              formAula.reset();
              loadAllContent(); 
          } catch (error) {
              showStatus(statusDiv, "Erro ao salvar aula: " + error.message, "error");
          }
      });
      
      // 4. Salvar Cursos Padr칚o
      formDefaultCourses.addEventListener('submit', async (e) => {
          e.preventDefault();
          const idsString = defaultCoursesInput.value; // Ex: "curso1,curso2"
          const coursesArray = idsString.split(',').map(id => id.trim()).filter(id => id.length > 0);
          
          try {
              await db.collection(CONFIG_COLLECTION).doc('default_courses').set({
                  coursesOwned: coursesArray
              });
              showStatus(statusDiv, "Lista de Cursos Padr칚o salva!", "success");
          } catch (error) {
              showStatus(statusDiv, "Erro ao salvar lista: " + error.message, "error");
          }
      });

      // 5. L칩gica de Login
      loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = document.getElementById('login-email').value;
          const password = document.getElementById('login-password').value;
          showStatus(loginStatusDiv, 'Tentando entrar...', 'loading');
          try {
              await auth.signInWithEmailAndPassword(email, password);
          } catch (error) {
              showStatus(loginStatusDiv, `Erro de Acesso: ${error.message}`, 'error');
          }
      });

      // 6. L칩gica de Logout
      btnLogout.addEventListener('click', async () => {
          await auth.signOut();
      });

      // 7. Verifica칞칚o de Estado de Autentica칞칚o (COM VERIFICA칂츾O DE ADMIN)
      auth.onAuthStateChanged(async (user) => {
          if (user) {
              try {
                  const userDoc = await db.collection(USERS_COLLECTION).doc(user.uid).get();
                  if (userDoc.exists && userDoc.data().isAdmin === true) {
                      loginSection.style.display = 'none';
                      adminSection.style.display = 'block';
                      loadAllContent(); 
                  } else {
                      showStatus(loginStatusDiv, "Erro: Voc칡 n칚o tem permiss칚o de Admin.", "error");
                      auth.signOut(); 
                  }
              } catch (error) {
                  console.error("Erro ao verificar permiss칚o de admin:", error);
                  showStatus(loginStatusDiv, `Erro de Permiss칚o: ${error.message}. Verifique as Regras.`, "error");
                  auth.signOut();
              }
          } else {
              loginSection.style.display = 'block';
              adminSection.style.display = 'none';
          }
      });
      
      // --- NOVO: L칍GICA DO FORMUL츼RIO 5 ---
      
      btnSearchStudent.addEventListener('click', async () => {
          const email = document.getElementById('student-email').value;
          if (!email) return;
          
          showStatus(statusDiv, "Procurando aluno...", "loading");
          studentLookupResult.style.display = 'none';
          foundStudentId = null;
          
          try {
              const querySnapshot = await db.collection(USERS_COLLECTION).where("email", "==", email).get();
              
              if (querySnapshot.empty) {
                  showStatus(statusDiv, "Aluno n칚o encontrado.", "error");
                  return;
              }
              
              const studentDoc = querySnapshot.docs[0];
              const studentData = studentDoc.data();
              foundStudentId = studentDoc.id; // Salva o ID do aluno
              
              document.getElementById('student-name').textContent = `Nome: ${studentData.name}`;
              document.getElementById('student-courses').textContent = (studentData.coursesOwned || []).join(', ') || "Nenhum";
              
              studentLookupResult.style.display = 'block';
              showStatus(statusDiv, "Aluno encontrado!", "success");
              
          } catch (error) {
              showStatus(statusDiv, "Erro ao procurar aluno: " + error.message, "error");
          }
      });
      
      btnAddCourseToStudent.addEventListener('click', async () => {
          const courseIdToAdd = selectCourseToAdd.value;
          if (!courseIdToAdd || !foundStudentId) {
              alert("Erro: Nenhum aluno ou curso selecionado.");
              return;
          }
          
          showStatus(statusDiv, "Liberando curso...", "loading");
          
          try {
              const studentRef = db.collection(USERS_COLLECTION).doc(foundStudentId);
              
              // Usa 'arrayUnion' para adicionar o ID ao array sem duplicar
              await studentRef.update({
                  coursesOwned: firebase.firestore.FieldValue.arrayUnion(courseIdToAdd)
              });
              
              showStatus(statusDiv, "Curso liberado com sucesso!", "success");
              // Recarrega os dados do aluno
              btnSearchStudent.click(); 
              
          } catch (error) {
              showStatus(statusDiv, "Erro ao liberar curso: " + error.message, "error");
          }
      });
        
    </script>

</body>
</html>
