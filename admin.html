<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Admin | JB Jidousha Cursos</title>
    
    <style>
        /* [Estilos do Admin - Focados em funcionalidade] */
        :root {
            --accent-color: #DAA520; 
            --action-color: #1463a5; 
            --error-color: #dc3545;
        }
        body { font-family: Arial, sans-serif; background-color: #f0f0f0; margin: 0; padding: 20px; }
        .container {
            max-width: 800px; 
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 2rem; 
            margin: 0 auto; 
        }
        h1 { text-align: center; color: var(--action-color); margin-top: 0; }
        h3 { color: var(--action-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 5px; }
        label { font-weight: bold; margin-bottom: 5px; display: block; }
        
        input[type="text"], input[type="password"], input[type="email"], textarea, select, input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box; 
        }
        
        button { 
            padding: 12px; 
            border: none; 
            border-radius: 4px; 
            font-size: 1rem; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%;
            background-color: var(--action-color);
            color: white;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #0d4a7c; }
        #btnLogout { background-color: #777; margin-top: 20px; }
        
        #status, #loginStatus { 
            text-align: center; 
            font-weight: bold; 
            margin-top: 15px; 
            padding: 10px; 
            border-radius: 4px; 
        }
        .status.success { color: #28a745; background-color: #e9f7ec; }
        .status.error { color: #dc3545; background-color: #fdeeee; }
        .status.loading { color: #007bff; background-color: #e6f2ff; }
        
        #login-section, #admin-section {
            border-top: 5px solid var(--accent-color);
            padding-top: 20px;
        }
        
        /* Estilos da lista de aulas */
        #modules-list { list-style-type: none; padding-left: 0; }
        .module-item { background-color: #f9f9f9; border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .module-item h4 { margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        .lesson-list-item { font-size: 0.9em; padding-left: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* NOVO: Estilo dos bot玫es de Excluir */
        .delete-btn {
            background-color: var(--error-color);
            color: white;
            padding: 4px 8px;
            font-size: 0.8em;
            width: auto; /* Tamanho autom谩tico */
            font-weight: normal;
        }
        .delete-btn.module-delete-btn {
            background-color: #c9302c; /* Vermelho mais escuro para M贸dulo */
        }
        
    </style>
</head>
<body>

    <div class="container">
        <h1>Admin JB Jidousha Cursos</h1>

        <section id="login-section">
            <h3>Acesso Restrito</h3>
            <form id="loginForm">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" required>
                
                <label for="login-password">Senha:</label>
                <input type="password" id="login-password" required>
                
                <button type="submit" id="btnLogin">Entrar</button>
            </form>
            <div id="loginStatus" class="status"></div>
        </section>

        <section id="admin-section" style="display: none;">
            
            <h3 style="margin-top:0;">Gerir Cursos</h3>
            
            <form id="formModulo">
                <h4>Adicionar Novo M贸dulo</h4>
                <label for="module-title">T铆tulo do M贸dulo:</label>
                <input type="text" id="module-title" placeholder="Ex: M贸dulo 1: Fundamentos" required>
                
                <label for="module-order">Ordem (N煤mero):</label>
                <input type="number" id="module-order" placeholder="1" required>
                
                <button type="submit">Salvar M贸dulo</button>
            </form>
            
            <hr style="margin: 30px 0;">
            
            <form id="formAula">
                <h4>Adicionar Nova Aula</h4>
                
                <label for="lesson-module">Selecionar M贸dulo:</label>
                <select id="lesson-module" required>
                    <option value="">-- Carregando m贸dulos... --</option>
                </select>
                
                <label for="lesson-title">T铆tulo da Aula:</label>
                <input type="text" id="lesson-title" placeholder="Ex: 1.1 Seguran莽a e Produtos" required>
                
                <label for="lesson-videoid">ID do V铆deo (YouTube):</label>
                <input type="text" id="lesson-videoid" placeholder="Ex: iWiE3_bToUk" required>
                
                <label for="lesson-description">Descri莽茫o Curta:</label>
                <textarea id="lesson-description" rows="3" placeholder="O que o aluno vai aprender..."></textarea>
                
                <label for="lesson-order">Ordem (N煤mero):</label>
                <input type="number" id="lesson-order" placeholder="1" required>

                <button type="submit" id="btnSalvarAula">Salvar Aula</button>
            </form>
            
            <div id="status" class="status"></div>

            <hr style="margin: 30px 0;">
            
            <h3>M贸dulos e Aulas Atuais</h3>
            <div id="modules-list">
                </div>

            <button id="btnLogout">Sair (Logout)</button>
        </section>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 

    <script>
      //  SUAS CHAVES REAIS
      const firebaseConfig = {
        apiKey: "AIzaSyB3LB3er6lGKd95kHmOlFvO_WappclfOEg",
        authDomain: "jb-jidousha-curso.firebaseapp.com",
        projectId: "jb-jidousha-curso",
        storageBucket: "jb-jidousha-curso.firebasestorage.app",
        messagingSenderId: "825134171693",
        appId: "1:825134171693:web:d4284a093ed261c97a1aa4",
        measurementId: "G-QLS2RVCTQ6"
      };

      // Inicializa莽茫o
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth(); 

      // Cole莽玫es
      const MODULOS_COLLECTION = "modulos";
      const AULAS_COLLECTION = "aulas";

      // Elementos do HTML
      const loginSection = document.getElementById('login-section');
      const adminSection = document.getElementById('admin-section');
      const loginForm = document.getElementById('loginForm');
      const loginStatusDiv = document.getElementById('loginStatus');
      const statusDiv = document.getElementById('status');
      const btnLogout = document.getElementById('btnLogout');
      
      const formModulo = document.getElementById('formModulo');
      const formAula = document.getElementById('formAula');
      const selectModule = document.getElementById('lesson-module');
      const modulesListDiv = document.getElementById('modules-list');

      function showStatus(div, message, type) {
          div.textContent = message;
          div.className = 'status ' + type; 
      }

      // --- LGICA DE CARREGAMENTO ---

      // Fun莽茫o para carregar os m贸dulos (no dropdown e na lista)
      async function loadModulesAndLessons() {
          selectModule.innerHTML = '<option value="">-- Selecione o M贸dulo --</option>';
          modulesListDiv.innerHTML = '<p>Carregando...</p>';
          
          let modulesHtml = '';
          
          try {
              // 1. Buscar M贸dulos
              const modulesSnapshot = await db.collection(MODULOS_COLLECTION).orderBy("order").get();
              
              if (modulesSnapshot.empty) {
                  modulesListDiv.innerHTML = '<p>Nenhum m贸dulo cadastrado ainda.</p>';
              }
              
              // 2. Buscar Aulas (Todas de uma vez)
              const lessonsSnapshot = await db.collection(AULAS_COLLECTION).orderBy("order").get();
              const allLessons = {};
              lessonsSnapshot.forEach(doc => {
                  const lesson = doc.data();
                  lesson.id = doc.id; // Salva o ID do documento
                  
                  if (!allLessons[lesson.moduleId]) {
                      allLessons[lesson.moduleId] = [];
                  }
                  allLessons[lesson.moduleId].push(lesson);
              });

              // 3. Renderizar M贸dulos e Aulas
              modulesSnapshot.forEach(doc => {
                  const modulo = doc.data();
                  
                  // Adiciona ao Dropdown
                  selectModule.innerHTML += `<option value="${doc.id}">${modulo.title}</option>`;
                  
                  // Adiciona  Lista de Visualiza莽茫o
                  modulesHtml += `<div class="module-item">
                                    <h4>
                                        ${modulo.title}
                                        <button class="delete-btn module-delete-btn" data-module-id="${doc.id}">Excluir M贸dulo</button>
                                    </h4>`;
                  
                  if (allLessons[doc.id] && allLessons[doc.id].length > 0) {
                      modulesHtml += '<ul class="lesson-list-item">';
                      allLessons[doc.id].forEach(lesson => {
                          modulesHtml += `
                            <li>
                                ${lesson.title}
                                <button class="delete-btn" data-lesson-id="${lesson.id}">Excluir</button>
                            </li>`;
                      });
                      modulesHtml += '</ul>';
                  } else {
                      modulesHtml += '<p class="lesson-list-item">Nenhuma aula neste m贸dulo.</p>';
                  }
                  
                  modulesHtml += '</div>';
              });
              
              modulesListDiv.innerHTML = modulesHtml;

          } catch (error) {
              console.error("Erro ao carregar m贸dulos/aulas:", error);
              showStatus(statusDiv, "Erro ao carregar conte煤do: " + error.message, "error");
          }
      }

      // --- LGICA DE EVENTOS ---

      // NOVO: Fun莽玫es de Excluir
      async function deleteLesson(id) {
          if (!confirm('Tem certeza que deseja EXCLUIR esta AULA?')) return;
          
          try {
              await db.collection(AULAS_COLLECTION).doc(id).delete();
              showStatus(statusDiv, "Aula exclu铆da com sucesso!", "success");
              loadModulesAndLessons(); // Recarrega
          } catch (error) {
              showStatus(statusDiv, "Erro ao excluir aula: " + error.message, "error");
          }
      }

      async function deleteModule(id) {
          if (!confirm('Tem certeza que deseja EXCLUIR este MDULO?\n\nATENO: Exclua todas as aulas dentro dele PRIMEIRO.')) return;
          
          try {
              await db.collection(MODULOS_COLLECTION).doc(id).delete();
              showStatus(statusDiv, "M贸dulo exclu铆do com sucesso!", "success");
              loadModulesAndLessons(); // Recarrega
          } catch (error) {
              showStatus(statusDiv, "Erro ao excluir m贸dulo: " + error.message, "error");
          }
      }
      
      // NOVO: Event listener para os cliques na lista (incluindo bot玫es de excluir)
      modulesListDiv.addEventListener('click', (e) => {
          if (e.target.classList.contains('delete-btn')) {
              if (e.target.classList.contains('module-delete-btn')) {
                  //  um bot茫o de excluir M贸dulo
                  deleteModule(e.target.dataset.moduleId);
              } else {
                  //  um bot茫o de excluir Aula
                  deleteLesson(e.target.dataset.lessonId);
              }
          }
      });


      // 1. Salvar M贸dulo
      formModulo.addEventListener('submit', async (e) => {
          e.preventDefault();
          const title = document.getElementById('module-title').value;
          const order = parseInt(document.getElementById('module-order').value);
          
          try {
              await db.collection(MODULOS_COLLECTION).add({
                  title: title,
                  order: order,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              showStatus(statusDiv, "M贸dulo salvo com sucesso!", "success");
              formModulo.reset();
              loadModulesAndLessons(); 
          } catch (error) {
              showStatus(statusDiv, "Erro ao salvar m贸dulo: " + error.message, "error");
          }
      });
      
      // 2. Salvar Aula
      formAula.addEventListener('submit', async (e) => {
          e.preventDefault();
          const moduleId = document.getElementById('lesson-module').value;
          const title = document.getElementById('lesson-title').value;
          const videoId = document.getElementById('lesson-videoid').value;
          const description = document.getElementById('lesson-description').value;
          const order = parseInt(document.getElementById('lesson-order').value);

          if (!moduleId) {
              showStatus(statusDiv, "Erro: Selecione um m贸dulo.", "error");
              return;
          }

          try {
              await db.collection(AULAS_COLLECTION).add({
                  moduleId: moduleId,
                  title: title,
                  videoId: videoId,
                  description: description,
                  order: order,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              showStatus(statusDiv, "Aula salva com sucesso!", "success");
              formAula.reset();
              loadModulesAndLessons(); 
          } catch (error) {
              showStatus(statusDiv, "Erro ao salvar aula: " + error.message, "error");
          }
      });

      // 3. L贸gica de Login
      loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = document.getElementById('login-email').value;
          const password = document.getElementById('login-password').value;
          showStatus(loginStatusDiv, 'Tentando entrar...', 'loading');
          try {
              await auth.signInWithEmailAndPassword(email, password);
          } catch (error) {
              showStatus(loginStatusDiv, `Erro de Acesso: ${error.message}`, 'error');
          }
      });

      // 4. L贸gica de Logout
      btnLogout.addEventListener('click', async () => {
          await auth.signOut();
      });

      // 5. Verifica莽茫o de Estado de Autentica莽茫o
      auth.onAuthStateChanged((user) => {
          if (user) {
              loginSection.style.display = 'none';
              adminSection.style.display = 'block';
              loadModulesAndLessons(); 
          } else {
              loginSection.style.display = 'block';
              adminSection.style.display = 'none';
          }
      });
        
    </script>

</body>
</html>
